bracket_data = {
    "east": [
        "uconn",
        "north_carolina",
        "illinois",
        "iowa_state",
        "south_carolina",
        "kentucky",
        "texas",
        "michigan_state",
        "boise_state",
        "texas_a&m",
        "indiana_state",
        "mcneese_state",
        "south_florida",
        "vermont",
        "colgate",
        "green_bay"
    ],
    "west": [
        "arizona",
        "tennessee",
        "wisconsin",
        "baylor",
        "creighton",
        "byu",
        "texas_tech",
        "virginia",
        "new_mexico",
        "butler",
        "ole_miss",
        "grand_canyon",
        "akron",
        "high_point",
        "troy",
        ["north_dakota", "grambling_state"]
    ],
    "midwest": [
        "purdue",
        "kansas",
        "auburn",
        "duke",
        "florida_atlantic",
        "colorado_state",
        "clemson",
        "saint_marys",
        "tcu",
        "florida",
        "nebraska",
        "samford",
        "cornell",
        "unc_wilmington",
        "east_washington",
        ["merrimack", "nc_central"]
    ],
    "south": [
        "houston",
        "marquette",
        "alabama",
        "dayton",
        "san_diego_state",
        "oklahoma",
        "utah_state",
        "utah",
        "northwestern",
        ["mississippi_state", "cincinnati"],
        ["washington_state", "seton_hall"],
        "uc_irvine",
        "lousiana_tech",
        "morehead_state",
        "quinnipiac",
        "eastern_kentucky"
    ]
}
nicknames = {
    "akron": "zips",
    "alabama": "crimson tide",
    "arizona_state": "sun devils",
    "arizona": "wildcats",
    "arkansas": "razorbacks",
    "auburn": "tigers",
    "baylor": "bears",
    "boise_state": "broncos",
    "bryant": "bulldogs",
    "butler": "bulldogs",
    "byu": "cougars",
    "charleston": "cougars",
    "chattanooga": "mocs",
    "cincinnati": "bearcats",
    "clemson": "tigers",
    "cleveland_state": "vikings",
    "colgate": "raiders",
    "colorado_state": "rams",
    "cornell": "big red",
    "creighton": "bluejays",
    "csu_fullerton": "titans",
    "davidson": "wildcats",
    "dayton": "flyers",
    "delaware": "blue hens",
    "drake": "bulldogs",
    "duke": "blue devils",
    "eastern_kentucky": "colonels",
    "east_washington": "eagles",
    "fdu": "knights",
    "florida": "gators",
    "florida_atlantic": "owls",
    "furman": "paladins",
    "georgia_state": "panthers",
    "gonzaga": "bulldogs",
    "grambling_state": "tigers",
    "grand_canyon": "antelopes",
    "green_bay": "phoenix",
    "high_point": "purple panthers",
    "houston": "cougars",
    "howard": "bison",
    "illinois": "fighting illini",
    "indiana": "hoosiers",
    "indiana_state": "sycamores",
    "iona": "gaels",
    "iowa_state": "cardinals",
    "iowa": "hawks",
    "jacksonville_state": "gamecocks",
    "kansas_state": "wildcats",
    "kansas": "jayhawks",
    "kennesaw_state": "owls",
    "kent_state": "golden flashes",
    "kentucky": "wildcats",
    "long_beach_state": "the beach",
    "longwood": "lancers",
    "louisiana": "ragin cajuns",
    "lousiana_tech": "bulldogs",
    "loyola_chicago": "ramblers",
    "lsu": "tigers",
    "marquette": "golden eagles",
    "maryland": "terrapins",
    "mcneese_state": "cowboys",
    "memphis": "tigers",
    "merrimack": "warriors",
    "miami": "hurricanes",
    "michigan_state": "spartans",
    "michigan": "wolverines",
    "mississippi_state": "bulldogs",
    "missouri": "mizzou",
    "montana_state": "fighting bobcats",
    "morehead_state": "eagles",
    "murray_state": "racers",
    "nc_central": "eagles",
    "nc_state": "wolfpack",
    "nebraska": "cornhuskers",
    "new_mexico": "lobos",
    "new_mexico_state": "aggies",
    "new_orleans": "privateers",
    "norfolk_state": "spartans",
    "north_carolina": "tar heels",
    "north_dakota": "fighting hawks",
    "north_texas": "mean green",
    "northern_iowa": "panthers",
    "northern_kentucky": "norse",
    "northwestern": "wildcats",
    "notre_dame": "fighting irish",
    "ohio_state": "buckeyes",
    "oklahoma": "sooners",
    "ole_miss": "rebels",
    "oral_roberts": "golden eagles",
    "penn_state": "nittany lions",
    "pittsburgh": "panthers",
    "providence": "friars",
    "purdue": "boilmakers",
    "quinnipiac": "bobcats",
    "richmond": "spiders",
    "rutgers": "scarlet knights",
    "saint_marys": "gaels",
    "saint_peters": "peacocks",
    "samford": "bulldogs",
    "san_diego_state": "aztecs",
    "san_francisco": "dons",
    "seton_hall": "pirates",
    "south_carolina": "gamecocks",
    "south_dakota_state": "jackrabbits",
    "south_florida": "bulls",
    "southeast_missouri_state": "redhawks",
    "tcu": "horned frogs",
    "tennessee": "volunteers",
    "texas_a&m_cc": "islanders",
    "texas_a&m": "aggies",
    "texas_southern": "tigers",
    "texas_state": "bobcats",
    "texas_tech": "red raiders",
    "texas": "longhorns",
    "toledo": "rockets",
    "troy": "trojans",
    "uab": "blazers",
    "ucla": "bruins",
    "uconn": "huskies",
    "ucsb": "bison",
    "uc_irvine": "anteaters",
    "unc_asheville": "bulldogs",
    "unc_wilmington": "seahawks",
    "usc": "trojans",
    "utah": "utes",
    "utah_state": "aggies",
    "vcu": "rams",
    "vermont": "catamounts",
    "villanova": "wildcats",
    "virginia_tech": "hokies",
    "virginia": "cavaliers",
    "wagner": "seahawks",
    "wake_forest": "demon deacons",
    "washington_state": "cougars",
    "west_virginia": "mountaineers",
    "wisconsin": "badgers",
    "wright_state": "raiders",
    "wyoming": "cowboys",
    "xavier": "musketeers",
    "yale": "bulldogs",
    "nevada": "wolf pack",
    "princeton": "tigers"
}
region_seeds = {
    "midwest": 1,
    "east": 2,
    "south": 3,
    "west": 4
}

const IMAGE_DIRECTORY = "img/"
// const IMAGE_DIRECTORY = "../imgs/"

function title(str) {
    return str.replace(/_/g, ' ').replace(/\b\w/g, match => match.toUpperCase());
}

function delay(milliseconds){
    return new Promise(resolve => {
        setTimeout(resolve, milliseconds);
    });
}

function generateRandomBinaryList() {
    const minLength = 10;
    const maxLength = 20;
    const randomLength = Math.floor(Math.random() * (maxLength - minLength + 1)) + minLength;

    const binaryList = [];
    for (let i = 0; i < randomLength; i++) {
        binaryList.push(i % 2);
    }

    return binaryList;
}

class Team {
    constructor(name, seed) {
        this.name = name;
        this.nickname = nicknames[name];
        this.seed = seed;
        this.pretty_name = title(`${this.name}`);
        this.pretty_name_nickname = title(`${this.name} ${this.nickname}`);
        this.display_name = `${this.seed}. ${this.pretty_name}`;
        this.image_path = `${IMAGE_DIRECTORY}${this.name}.jpg`;
    }

    getHTML() {
        return `
            <h3 style="margin-left: 20px">${this.pretty_name_nickname}</h3>
            <img class="mascot-image" src="${this.image_path}" alt="${this.pretty_name_nickname}">
        `
    }
}

class EffectiveSeed {
    constructor(effective_seed_idx, teams) {
        this.effective_seed_idx = effective_seed_idx;
        this.teams = teams;
        this.display_name = this.teams.map(team => team.display_name).join(" / ");
    }
    
    displayFull() {
        let inner_HTML_list = []
        for (let i=0; i < this.teams.length; i++) {
            let team = this.teams[i];
            let inner_HTML_team = `
                <div class="image-container">
                    ${team.getHTML()}
                </div>
            `;
            inner_HTML_list.push(inner_HTML_team);
        }
        return inner_HTML_list.join("");
    }
}

class MatchupPair {
    constructor(top_team, bot_team) {
        this.top_team = top_team;
        this.bot_team = bot_team;
        this.teams = [top_team, bot_team];
        this.current_selection = null;
    }
    
    display() {
        document.querySelector('.match-container').innerHTML = `
            <div class="image-container" onclick="current_region.selectWinner(0)">
                ${this.top_team.getHTML()}
                <div class="selection-box" id="selection0"></div>
            </div>
            <div class="image-container" onclick="current_region.selectWinner(1)">
                ${this.bot_team.getHTML()}
                <div class="selection-box" id="selection1"></div>
            </div>
        `;
    }

    selectWinner(idx) {
        document.getElementById(`selection${idx}`).style.display = 'block';
        document.getElementById(`selection${1-idx}`).style.display = 'none';
        this.current_selection = this.teams[idx];
    }
}

class Matchup {
    constructor(top_seed, bot_seed) {
        this.top_seed = top_seed;
        this.bot_seed = bot_seed;

        this.possible_matchup_pairs = [];
        for (let i=0; i<this.top_seed.teams.length; i++) {
            for (let j=0; j<this.bot_seed.teams.length; j++) {
                this.possible_matchup_pairs.push(new MatchupPair(this.top_seed.teams[i], this.bot_seed.teams[j]));
            }
        }
        this.current_matchup_pair_idx = 0;
        this.winners = [];
    }

    selectWinner(idx) {
        this.possible_matchup_pairs[this.current_matchup_pair_idx].selectWinner(idx);
    }

    displayMatchupPair() {
        this.possible_matchup_pairs[this.current_matchup_pair_idx].display();
    }

    submitMatchupPair() {
        let winner = this.possible_matchup_pairs[this.current_matchup_pair_idx].current_selection;
        if (winner === null) {
            return null;
        }
        if (!this.winners.includes(winner)) {
            this.winners.push(winner);
        }
        this.current_matchup_pair_idx++;
        return true;
    }

    isComplete() {
        return this.current_matchup_pair_idx >= this.possible_matchup_pairs.length;
    }

    getNextEffectiveSeed() {
        return new EffectiveSeed(this.top_seed.effective_seed_idx, this.winners);
    }
}

class Round {
    constructor(round_number, num_seeds, prefix="") {
        this.round_number = round_number;
        this.num_seeds = num_seeds;
        this.seeds = {};
        for (let i = 1; i <= num_seeds; i++) {
            this.seeds[i] = null;
        }
        this.num_matchups = Math.floor(num_seeds / 2);
        this.matchups = []
        this.current_matchup_idx = null;
        this.prefix = prefix;
    }

    updateHTMLBracket(effective_seed_idx) {
        var dynamicTextSpan = document.getElementById(`${this.prefix}rnd${this.round_number}-eSeed${effective_seed_idx}`);
        let effective_seed = this.seeds[effective_seed_idx]
        if (effective_seed == null){
            dynamicTextSpan.textContent = "";
        } else {
            dynamicTextSpan.textContent = effective_seed.display_name;
        }
    }

    initializeMatchups(){
        if (this.matchups.length > 0) {
            return;
        }
        for (let i = 1; i <= this.num_matchups; i++) {
            this.matchups.push(new Matchup(this.seeds[i], this.seeds[this.num_seeds - i + 1]));
        }
        this.current_matchup_idx = 0;
    }

    isReady() {
        for (key in this.seeds) {
            if (this.seeds[key] === null) {
                return false;
            }
        }
        this.initializeMatchups();
        return true;
    }

    addSeed(effective_seed, update_html=true) {
        this.seeds[effective_seed.effective_seed_idx] = effective_seed;
        if (update_html){
            this.updateHTMLBracket(effective_seed.effective_seed_idx);
        }
        return this.isReady()
    }

    setHTML() {
        for (key in this.seeds) {
            this.updateHTMLBracket(key);
        }
    }

    selectWinner(idx) {
        this.matchups[this.current_matchup_idx].selectWinner(idx);
    }

    displayMatchup() {
        this.matchups[this.current_matchup_idx].displayMatchupPair();
    }

    submitMatchup() {
        let matchup = this.matchups[this.current_matchup_idx];
        let result = matchup.submitMatchupPair();
        if (result === null) {
            return null;
        }
        if (matchup.isComplete()) {
            this.current_matchup_idx++;
            return matchup.getNextEffectiveSeed();
        }

        return null;
    }

    isComplete() {
        if (!this.isReady()) {
            return false;
        }
        for (key in this.matchups) {
            if (this.matchups[key] === null) {
                return false;
            }
            if (!this.matchups[key].isComplete()) {
                return false;
            }
        }
        return true;
    }
}

class RegionBracket {
    constructor(region_name, num_rounds) {
        this.region_name = region_name;
        this.num_rounds = num_rounds;
        this.rounds = {};
        for (let i = 1; i <= num_rounds; i++) {
            let num_seeds = 2 ** (num_rounds - i + 1);
            if (region_name == "final_four") {
                this.rounds[i] = new Round(i, num_seeds, "ff-");
            } else {
                this.rounds[i] = new Round(i, num_seeds);
            }
        }
        this.current_round_idx = 1;
        this.region_winner = null;
    }

    addSeed(effective_seed, update_html=true) {
        this.rounds[this.current_round_idx].addSeed(effective_seed, update_html);
    }

    setHTML() {
        for (key in this.rounds) {
            this.rounds[key].setHTML();
        }
    }

    selectWinner(idx) {
        this.rounds[this.current_round_idx].selectWinner(idx);
    }

    async selectRandom() {
        let idxs = generateRandomBinaryList();
        let mean_wait_time = Math.floor(3000 / idxs.length);
        // Start with small wait time and gradually increase
        // Total animation shold be ~2 seconds
        // Mean wait time is 2 seconds / N
        // Min wait time is 1/8 * mean wait time
        // Thefore slope = 14 * mean_wait_time / (8 * N)
        let min_wait_time = mean_wait_time/8;
        let slope = 14 * mean_wait_time / (8 * idxs.length);

        for (let i=0; i<idxs.length; i++) {
            let idx = idxs[i];
            this.selectWinner(idx);
            await delay(min_wait_time + (i * slope));
        }
    }

    displayWinner() {
        let winner_str = "winner";
        let is_are_str = "is";
        if (this.region_winner.teams.length > 1) {
            winner_str = "winners";
            is_are_str = "are";
        }
        let message = "";
        if (this.region_name == "final_four") {
            message = `
                <div style="display: block">
                <h2>Your overall ${winner_str} ${is_are_str}...</h2>
                <div style="display: flex">${this.region_winner.displayFull()}</div>
                </div>
            `;
        } else {
            message = `
                <div style="display: block">
                <h2>Your ${winner_str} of the ${title(this.region_name)} ${is_are_str}...</h2>
                <div style="display: flex">${this.region_winner.displayFull()}</div>
                ${get_region_instructions()}
                </div>
            `;
        }
        document.querySelector('.match-container').innerHTML = message;
    }

    isComplete() {
        for (key in this.rounds) {
            if (!this.rounds[key].isComplete()) {
                return false;
            }
        }
        return true;
    }

    displayChoice(){
        var matchup_buttons = document.getElementById('matchup-buttons');
        if (this.isComplete()){
            matchup_buttons.classList.add("hidden");
            this.displayWinner()
        } else if (!this.rounds[this.current_round_idx].isReady()) {
            matchup_buttons.classList.add("hidden");
            document.querySelector('.match-container').innerHTML = `
            <div style="display: block">
            <h2>Please complete other regions first.</h2>
            ${get_region_instructions(true)}
            </div>
        `;
        } else {
            matchup_buttons.classList.remove("hidden");
            this.rounds[this.current_round_idx].displayMatchup()
        }
    }

    setRegionWinner(winner) {
        this.region_winner = winner;

        if (this.region_name === "final_four") {
            var dynamicTextSpan = document.getElementById(`ff-region-winner`);
        } else {
            var dynamicTextSpan = document.getElementById(`region-winner`);
        }
        dynamicTextSpan.textContent = this.region_winner.display_name;

        if (this.region_name != "final_four") {
            let effective_seed = new EffectiveSeed(region_seeds[this.region_name], winner.teams);
            brackets["final_four"].addSeed(effective_seed, false)
        }
    }

    submitChoice() {
        let current_round = this.rounds[this.current_round_idx];
        let winner = current_round.submitMatchup();
        if (winner != null) {
            if (this.current_round_idx < this.num_rounds) {
                // Add winner to next round
                this.rounds[this.current_round_idx + 1].addSeed(winner);
            } else {
                this.setRegionWinner(winner)
            }
        }
        if (current_round.isComplete()) {
            this.current_round_idx++;
        }

        this.displayChoice()
    }
}

brackets = {
    "east": new RegionBracket("east", 4),
    "west": new RegionBracket("west", 4),
    "midwest": new RegionBracket("midwest", 4),
    "south": new RegionBracket("south", 4),
    "final_four": new RegionBracket("final_four", 2),
}


function initialize_effective_seed(team_names, seed) {
    if (typeof team_names === 'string') {
        team_names = [team_names];
    }
    let teams = team_names.map(team_name => new Team(team_name, seed));
    return new EffectiveSeed(seed, teams);
}


function initialize() {
    for (key in bracket_data) {
        let region_bracket = brackets[key];
        let region_data = bracket_data[key];
        for (let i=0; i<region_data.length; i++) {
            team_names = region_data[i];
            seed = i + 1;
            region_bracket.addSeed(initialize_effective_seed(team_names, seed), false);
        }
    }
}


function updateRegion(region_name) {
    current_region = brackets[region_name];
    var regions_bracket = document.getElementById('regions-bracket');
    var final_four_bracket = document.getElementById('final-four-bracket');

    if (region_name == "final_four") {
        regions_bracket.classList.add("hidden");
        final_four_bracket.classList.remove("hidden");
    } else {
        final_four_bracket.classList.add("hidden");
        regions_bracket.classList.remove("hidden");
    }

    var buttons = {
        "east": document.getElementById('east_button'),
        "west": document.getElementById('west_button'),
        "midwest": document.getElementById('midwest_button'),
        "south": document.getElementById('south_button'),
        "final_four": document.getElementById('final_four_button'),
    }
    for (key in buttons) {
       let button = buttons[key];
        if (key == region_name) {
            button.classList.add("current-region");
        } else {
            button.classList.remove("current-region");
        }
    }
    current_region.setHTML();
    current_region.displayChoice();

    const navLinks = document.querySelector('.nav-links');
    navLinks.classList.remove('show');
}


function get_remaining_regions(ignore_current_region=false){
    let remaining_regions = []
    for (let key in brackets) {
        if (!brackets[key].isComplete()) {
            if (!(ignore_current_region & (current_region.region_name === key))) {
                remaining_regions.push(title(key))
            }
        }
    }

    if (remaining_regions.length === 1) {
        return remaining_regions[0];
    } else if (remaining_regions.length === 2) {
        return remaining_regions.join(" and ");
    } else if (remaining_regions.length > 2){
        let all_but_last_list = remaining_regions.slice(0, -1);
        return all_but_last_list.join(", ") + ", and " + remaining_regions[remaining_regions.length-1]
    }
}


function get_region_instructions(ignore_current_region=false){
    const screenWidth = window.innerWidth;
    if (screenWidth < 768) {
        return `<div><p>Please complete the following region(s) by clicking on the &#9776; button in the top left corner of your screen: ${get_remaining_regions(ignore_current_region)}.</p></div>`;
    }
    return `<div><p>Please complete the following region(s) by clicking on them in the navigation menu on the top of the screen: ${get_remaining_regions(ignore_current_region)}.</p></div>`;
}


current_region = null;


window.onload = function() {
    initialize();
    updateRegion("east");
};

document.addEventListener('DOMContentLoaded', function () {
    const burgerMenu = document.querySelector('.burger-menu');
    const navLinks = document.querySelector('.nav-links');

    burgerMenu.addEventListener('click', function () {
        navLinks.classList.toggle('show');
    });
});